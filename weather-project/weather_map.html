<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="css/weather.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.css">
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.css' rel='stylesheet' />
    <link href="https://fonts.googleapis.com/css?family=Baloo+Paaji|Roboto&display=swap" rel="stylesheet">
    <title>Weather or Not</title>
</head>
<body>
<header>
    <span class="heading">Weather Forecast</span>
    <span id="date"></span>
    <span id="time"></span>
</header>
<h3 id="city"> SAN ANTONIO, TX</h3>
<div id="threeDayForecast" class="row"></div>
<div id="mapContainer">
    <div id="map"></div>

</div>
<div id="searchContainer">
    <div id='geocoder' class='geocoder this' ></div>

</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.2.1/mapbox-gl.js'></script>
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.1/mapbox-gl-geocoder.min.js'></script>
<script src="js/keys.js"></script>
<script src="js/mapbox-utils.js"></script>
<script>
    "use strict";
    (function () {

        //STARTS MAP AT SAN ANTONIO

        var weatherLocation = '29.4241, -98.4936';
        mapboxgl.accessToken = mapboxToken;
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v9',
            zoom: 10,
            center: [-98.4936, 29.4241]

        });

        //DATE AND TIME

        var today = new Date().toDateString();
        var time = new Date().toLocaleTimeString();
        $('#date').html(today);
        $('#time').html(time);

        setInterval(function () {
            time = new Date().toLocaleTimeString();
            var hour = new Date().getHours();
            console.log(hour);
            $('#time').html(time);
            if(hour >= 20){
                $('body').addClass('nightmode');
                map.setStyle('mapbox://styles/mapbox/dark-v10');
            }

        }, 1000);

        //STARTS MARKER AT SAN ANTONIO

        var marker = new mapboxgl.Marker({
            draggable: true
        })
            .setLngLat([-98.4936, 29.4241])
            .addTo(map);


        //STARTS WEATHER FORECAST AT SAN ANTONIO

        var ajaxStuff = function() {
            $.get("https://cors-anywhere.herokuapp.com/https://api.darksky.net/forecast/" + darkSkyKey + '/' + weatherLocation).done(function (data) {

                $('#threeDayForecast').html('');

                //THREE DAY FORECAST

                for (var i = 0; i < 3; i++) {
                    var day = data.daily.data[i];

                    var dateObject = new Date((day.time) * 1000);

                    dateObject = dateObject.toDateString();

                    dateObject = dateObject.slice(0, 10);

                    //DECIDES WHAT ICON TO USE

                    function whatIcon(day) {
                        var iconToUse;
                        if (day.icon === 'clear-day') {
                            iconToUse = '<img src="icon/sunny.png" height="100" width="100"/>'
                        } else if (day.icon === 'clear-night') {
                            iconToUse = '<img src="icon/moon.png" height="100" width="100"/>'
                        } else if (day.icon === 'partly-cloudy-day') {
                            iconToUse = '<img src="icon/partly-cloudy-day.png" height="100" width="100"/>'
                        } else if (day.icon === 'partly-cloudy-night') {
                            iconToUse = '<img src="icon/partly-cloudy-night.png" height="100" width="100"/>'
                        } else if (day.icon === 'cloudy') {
                            iconToUse = '<img src="icon/cloudy.png" height="100" width="100"/>'
                        } else if (day.icon === 'rain') {
                            iconToUse = '<img src="icon/rain.png" height="100" width="100"/>'
                        } else if (day.icon === 'sleet') {
                            iconToUse = '<img src="icon/sleet.png" height="100" width="100"/>'
                        } else if (day.icon === 'snow') {
                            iconToUse = '<img src="icon/snow.png" height="100" width="100"/>'
                        } else if (day.icon === 'wind') {
                            iconToUse = '<img src="icon/wind.png" height="100" width="100"/>'
                        } else if (day.icon === 'fog') {
                            iconToUse = '<img src="icon/fog.png" height="100" width="100"/>'
                        }

                        return iconToUse;
                    }

                    var icon = whatIcon(day);

                    //UPDATES HTML WITH THREE DAY FORECAST

                    $('#threeDayForecast').append(
                        '<div class="col-sm-4">' +
                        '   <div class="card">' +
                        '       <div class="card-body">' +
                        '           <h5 class="card-title">'+ dateObject +  `<br>`+ day.apparentTemperatureHigh.toFixed(0) + '째' + '/' + day.apparentTemperatureLow.toFixed(0) + '째' + '</h5>' +
                        '           <span>' + icon + '</span>' +
                        '           <ul>' +
                        '              <li>' + 'Humidity: ' + day.humidity + '</li>' +
                        '              <li>' + 'Wind: ' + day.windGust + '</li>' +
                        '              <li>' + 'Pressure: ' + day.pressure + '</li> ' +
                        '           </ul>' +
                        '       </div>' +
                        '   </div>' +
                        '</div>'
                    );
                }
            });
        };

        ajaxStuff();

        //CHANGES WHEN MARKER MOVES

        function onDragEnd() {
            var coordinates = marker.getLngLat();
            var latitude = coordinates.lat;
            var longitude = coordinates.lng;
            var weatherLocation = latitude + ',' + longitude;

            reverseGeocode(coordinates , mapboxToken).then(function (result) {
                $('#city').html(result.toUpperCase());
            });

            $.get("https://cors-anywhere.herokuapp.com/https://api.darksky.net/forecast/"+ darkSkyKey + '/'+ weatherLocation).done(function (data) {

                $('#threeDayForecast').html('');

                //THREE DAY FORECAST

                for (var i = 0; i < 3; i++){
                    var day = data.daily.data[i];

                    //DECIDES WHAT ICON TO USE

                    function whatIcon(day){
                        var iconToUse;
                        if (day.icon === 'clear-day'){
                            iconToUse = '<img src="icon/sunny.png" height="100" width="100"/>'
                        } else if(day.icon === 'clear-night'){
                            iconToUse = '<img src="icon/moon.png" height="100" width="100"/>'
                        }else if(day.icon === 'partly-cloudy-day'){
                            iconToUse = '<img src="icon/partly-cloudy-day.png" height="100" width="100"/>'
                        }else if(day.icon === 'partly-cloudy-night'){
                            iconToUse = '<img src="icon/partly-cloudy-night.png" height="100" width="100"/>'
                        }else if (day.icon === 'cloudy'){
                            iconToUse = '<img src="icon/cloudy.png" height="100" width="100"/>'
                        }else if (day.icon === 'rain'){
                            iconToUse = '<img src="icon/rain.png" height="100" width="100"/>'
                        }else if (day.icon === 'sleet'){
                            iconToUse = '<img src="icon/sleet.png" height="100" width="100"/>'
                        }else if (day.icon === 'snow'){
                            iconToUse = '<img src="icon/snow.png" height="100" width="100"/>'
                        }else if (day.icon === 'wind'){
                            iconToUse = '<img src="icon/wind.png" height="100" width="100"/>'
                        }else if (day.icon === 'fog'){
                            iconToUse = '<img src="icon/fog.png" height="100" width="100"/>'
                        }

                        return iconToUse;
                    }

                    var icon = whatIcon(day);

                    //UPDATES HTML WITH THREE DAY FORECAST

                    $('#threeDayForecast').append(
                        '<div class="col-sm-4">' +
                        '   <div class="card">' +
                        '       <div class="card-body">' +
                        '           <h5 class="card-title">' + day.apparentTemperatureHigh.toFixed(0) + '째' + '/' + day.apparentTemperatureLow.toFixed(0) + '째' + '</h5>' +
                        '           <span>' + icon + '</span>' +
                        '           <ul>' +
                        '              <li>' + 'Humidity: ' + day.humidity + '</li>' +
                        '              <li>' + 'Wind: ' + day.windGust + '</li>' +
                        '              <li>' + 'Pressure: ' + day.pressure + '</li> ' +
                        '           </ul>' +
                        '       </div>' +
                        '   </div>' +
                        '</div>'
                    );
                }
            });
        }

        marker.on('dragend', onDragEnd);

        //UPDATES MAP AND CITY NAME BY SEARCHING

        var geocoder = new MapboxGeocoder({
            accessToken: mapboxToken,
            mapboxgl: mapboxgl,
            mapMarker: null
        });

        document.getElementById('geocoder').append(geocoder.onAdd(map));

        $('#geocoder').change(function (e) {
            geocoder.mapMarker.remove();
            var location = geocoder.inputString;
            console.log(geocoder);
            geocode(location , mapboxToken).then(function (result) {
                map.flyTo({ center:result});
                $('#city').html(location.toUpperCase());
                marker.setLngLat(result);
                weatherLocation = result.reverse().join(',');

                ajaxStuff();
            });
        });

    })();

</script>

</body>
